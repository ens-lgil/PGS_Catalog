{% extends 'catalog/base.html' %}
{% load render_table from django_tables2 %}

{% block title %}Test DB benchmark{{ trait.label }} (Polygenic Trait){% endblock %}

{% block content %}
    <nav aria-label="You are here:">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">PGS Catalog</a></li>
        <li class="breadcrumb-item"><a href="/benchmark/"><span class="fa fa-bar-chart pr-1 pgs_color_1" style="line-height:21px"></span>Benchmarking</a></li>
        <li class="breadcrumb-item">{{ trait.id }}</li>
      </ol>
    </nav>

    <h2><span class="fa fa-bar-chart pr-2"></span>Trait: <span class="pgs_title">{{ trait.label }}</span></h2>

    <section>
      <table class="table table-bordered table_pgs_h mt-4">
        <tbody>
          <tr>
            <td class="table_title table_title_c" colspan="2">
              {% if 'EFO' in trait.id %}
                Experimental Factor Ontology (EFO) Information
              {% else %}
                Trait Information
              {% endif %}
            </td>
          </tr>
          <tr>
            <td>Identifier</td>
            <td><b>{{ trait.id }}</b></td>
          </tr>
          {% if trait.description %}
            <tr>
              <td>Description</td>
              <td>
                <span class="more">{{ trait.description }}</span>
              </td>
            </tr>
          {% endif %}
          {% if trait.display_phenotype_structured|length > 0 %}
            <tr>
              <td>Classification</td>
              <td>
                {% if trait.display_phenotype_structured|length > 1 %}
                  <a class="toggle_btn" data-toggle="tooltip" data-placement="right"  data-delay="500" id="trait_codes" title="Click to show/hide the list of classifications (e.g. ICD)"><b>{{ trait.display_phenotype_structured|length }}</b> classifications <i class="fa fa-plus-circle"></i></a>
                  <div class="toggle_list" id="list_trait_codes">
                    <ul>
                    {% for phenotype_structured in trait.display_phenotype_structured %}
                      <li>{{ phenotype_structured|safe }}</li>
                    {% endfor %}
                    </ul>
                  </div>
                {% else %}
                  {{ trait.display_phenotype_structured.0|safe }}
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section>
      <h3>Cohort(s)</h3>
      <div class="pgs_benchmark_cohorts clearfix">
      {% for cohort, cohort_data in cohorts.items %}
        <div>
          <div class="pgs_benchmark_cohort_title mt-2 mb-2">{{ cohort_data.name }} ({{ cohort }})</div>
          <table class="table table-bordered table-hover" data-toggle="table">
            <thead>
              <tr><th>Ancestry</th><th>Sample Numbers max</th></tr>
            </thead>
            <tbody>
                {% for ancestry_data in cohort_data.ancestries %}
                  <tr>
                    <td>{{ ancestry_data.name }}</td>
                    <td>{{ ancestry_data.display|safe }}</td>
                  </tr>
                {% endfor %}
            </tbody>
          </table>


        </div>
      {% endfor %}
      </div>
    </section>

    <section>
      <h3>Benchmark</h3>
      <div class="pgs_benchmark_form" style="display:flex;margin-bottom:1rem">
        <div style="display:flex">
          <!-- Cohort form -->
          <div id="benchmark_cohort" class="filter_container mr-3">
            <div class="filter_header mb-1">Cohort</div>
            <div id="benchmark_cohort_list"></div>
          </div>
          <!-- Ancestry form -->
          <div id="benchmark_ancestry" class="filter_container mr-3">
            <div class="filter_header mb-1">Ancestry</div>
            <div id="benchmark_ancestry_list"></div>
          </div>
        </div>
        <div style="display:flex">
          <!-- Performance metric form -->
          <div id="benchmark_metric" class="filter_container mr-3">
            <div class="filter_header mb-2">Performance metric</div>
            <div>
              <select id="benchmark_metric_select"></select>
            </div>
          </div>
          <!-- Sex form -->
          <div id="benchmark_sex_type" class="filter_container mr-3">
            <div class="filter_header mb-1">Sex</div>
            <div id="benchmark_sex_list"></div>
          </div>
          <!-- Data ordering -->
          <div id="benchmark_ordering" class="filter_container mr-3">
            <div class="filter_header mb-1">Order by</div>
            <div id="benchmark_order_by_list">
              <div>
                <input type="radio" name="benchmark_order_by" class="benchmark_order_by_rb" value="ancestry" id="bm_order_by_0" checked>
                <label class="mb-0" for="bm_order_by_0">Ancestry</label>
              </div>
              <div>
                <input type="radio" name="benchmark_order_by" class="benchmark_order_by_rb" value="cohort" id="bm_order_by_1">
                <label class="mb-0" for="bm_order_by_1">Cohort</label>
              </div>
            </div>
          </div>
          <!-- Data sorting -->
          <div id="benchmark_sorting" class="filter_container">
            <div class="filter_header mb-2">Sort by</div>
            <div>
              <select id="benchmark_sorting_select"></select>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div id="pgs_chart_super_container">
          <div id="pgs_chart_container">
            <svg id="pgs_chart"></svg>
          </div>
        </div>
        <div style="clear:both"></div>
      </div>
      <div>
        <div class="pgs_benchmark_downloads mt-2">
          <div class="pgs_benchmark_downloads_title">Export</div>
          <div style="display:flex">
            <div class="btn btn-pgs-small pgs_no_icon_link mr-2" id="exportPDF"><span class="fa fa-file-pdf-o mr-2"></span>PDF</div>
            <div class="btn btn-pgs-small pgs_no_icon_link mr-2" id="exportSVG"><span class="fa fa-file-image-o mr-2"></span>SVG</div>
            <div class="btn btn-pgs-small pgs_no_icon_link mr-2" id="exportPNG"><span class="fa fa-file-image-o mr-2"></span>PNG</div>
          </div>
          <div style="display:flex">
            <a class="btn btn-pgs-small pgs_no_icon_link mr-2" id="exportJSON"><span class="fa fa-file-text-o mr-2"></span>JSON</a>
            <a class="btn btn-pgs-small pgs_no_icon_link" id="exportCSV"><span class="fa fa-file-text-o mr-2"></span>CSV</a>
          </div>
        </div>
        <div style="clear:both"></div>
      </div>

      <script type="text/javascript">

        const pgs_data = {{ pgs_data|safe }};
        //var width = document.documentElement.clientWidth,
        //    height = document.documentElement.clientHeight;
        var max_width = 1200;
        var width = max_width,
            height = 500;

        $( document ).ready(function() {

          // Cohorts
          fill_cohort_form(pgs_data);
          var cohorts = set_cohortsList();

          // Ancestry
          fill_ancestry_form(pgs_data,cohorts);

          // Performance metric
          fill_metric_form(pgs_data,cohorts);

          // Sex
          fill_sex_form(pgs_data,cohorts);

          // Sorting by
          fill_sorting_form(pgs_data,cohorts);

          var doc_width = $('.container-fluid').width();
          if (doc_width < 1200) {
            width = doc_width-20;
          }
          if (width < 500) {
            width = 500;
          }
          console.log('width: '+width);
          console.log('doc_width: '+doc_width);


          var benchmark = new PGSBenchmark(pgs_data,width,height);

          $("#benchmark_cohort_list").on("change", ".benchmark_cohort_cb", function() {
            // Prevent having only unchecked checkboxes
            if ($(".benchmark_cohort_cb:checked").parent(':visible').length == 0 && !$(this).prop('checked')) {
              $(this).prop("checked", true);
            }
            else {
              benchmark.update_cohort();
            }
          });

          $("#benchmark_ancestry_list").on("change", ".benchmark_ancestry_cb",function() {
            // Prevent having only unchecked checkboxes
            if ($(".benchmark_ancestry_cb:checked").parent(':visible').length == 0 && !$(this).prop('checked')) {
              $(this).prop("checked", true);
            }
            else {
              benchmark.update_ancestry();
            }
          });

          $("#benchmark_metric_select").change(function() {
            benchmark.update_metric();
          });

          $("#benchmark_sex_list").change(function() {
            benchmark.update_sex();
          });

          $('input[name="benchmark_order_by"]:radio').change(function() {
            benchmark.update_ordering();
          });

          $("#benchmark_sorting_select").change(function() {
            benchmark.update_sorting();
          });

          window.addEventListener('resize', function(event){
            benchmark.redraw_chart();
          });
        });
      </script>
    </section>

    <section>
      {% if table_scores %}
        <h3>Polygenic Score(s)</h3>
        {% render_table table_scores %}
      {% endif %}
    </section>

{% endblock %}
